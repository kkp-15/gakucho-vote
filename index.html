<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å¥½ããªå­¦é•·ã®æ›²ã¯ï¼Ÿ</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { padding: 8px; margin: 5px; }
    .option { margin: 10px 0; }
    a { text-decoration: none; margin-right: 10px; }
    #log { margin-top: 20px; background: #f5f5f5; padding: 10px; font-size: 14px; border-left: 4px solid #999; }
  </style>
</head>
<body>
  <h1>å¥½ããªå­¦é•·ã®æ›²ã¯ï¼Ÿ</h1>

  <div id="log">ãƒ­ã‚°ï¼š</div>

  <h3>æ–°ã—ã„æ›²ã‚’è¿½åŠ </h3>
  <input type="text" id="songName" placeholder="æ›²å" />
  <input type="url" id="songUrl" placeholder="ãƒªãƒ³ã‚¯ï¼ˆhttps://ã€œï¼‰" />
  <button onclick="addOption()">è¿½åŠ </button>

  <div id="options"></div>

  <script>
    const log = (msg) => {
      document.getElementById("log").innerText += "\n" + msg;
      console.log(msg);
    };

    const firebaseConfig = {
      apiKey: "AIzaSyCFpBVVdN_dLLCq45yQxxxxxxx",
      authDomain: "gakucho-vote.firebaseapp.com",
      databaseURL: "https://gakucho-vote-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gakucho-vote",
      storageBucket: "gakucho-vote.appspot.com",
      messagingSenderId: "163899893304",
      appId: "1:163899893304:web:928b73xxxxxxxx"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const optionsDiv = document.getElementById("options");

    function hasVoted() {
      return localStorage.getItem("hasVoted") === "true";
    }

    function markVoted() {
      localStorage.setItem("hasVoted", "true");
    }

    function loadVotes() {
      log("loadVotes å®Ÿè¡Œä¸­...");
      db.ref("songs").on("value", (snapshot) => {
        const data = snapshot.val() || {};
        optionsDiv.innerHTML = "";
        log("ãƒ‡ãƒ¼ã‚¿å–å¾—: " + JSON.stringify(data));

        Object.entries(data)
          .sort((a, b) => (b[1].votes || 0) - (a[1].votes || 0))
          .forEach(([key, value], index) => {
            const wrapper = document.createElement("div");
            wrapper.className = "option";

            const rankNum = index + 1;
            const crown = rankNum === 1 ? "ğŸ‘‘" : rankNum === 2 ? "ğŸ¥ˆ" : rankNum === 3 ? "ğŸ¥‰" : `${rankNum}.`;
            const rank = document.createElement("span");
            rank.textContent = `${crown} `;
            wrapper.appendChild(rank);

            const link = document.createElement("a");
            link.href = value.url;
            link.textContent = value.name;
            link.target = "_blank";
            wrapper.appendChild(link);

            const btn = document.createElement("button");
            btn.textContent = `æŠ•ç¥¨ (${value.votes || 0}ç¥¨)`;
            btn.onclick = () => vote(key, value.votes || 0);
            if (!hasVoted()) wrapper.appendChild(btn);

            optionsDiv.appendChild(wrapper);
          });
      }, (error) => {
        log("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + error.message);
      });
    }

    function vote(key, currentVotes) {
      if (hasVoted()) {
        alert("ã™ã§ã«æŠ•ç¥¨æ¸ˆã¿ã§ã™ï¼");
        return;
      }
      db.ref("songs/" + key + "/votes").set(currentVotes + 1)
        .then(() => {
          log(`æŠ•ç¥¨æˆåŠŸ: ${key}`);
          markVoted();
        })
        .catch((err) => log("æŠ•ç¥¨ã‚¨ãƒ©ãƒ¼: " + err.message));
    }

    function addOption() {
      const name = document.getElementById("songName").value.trim();
      const url = document.getElementById("songUrl").value.trim();
      if (!name || !url) {
        alert("æ›²åã¨ãƒªãƒ³ã‚¯ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const key = name.replace(/[.#$\[\]]/g, "_");
      db.ref("songs/" + key).set({ name, url, votes: 1 })
        .then(() => {
          log(`è¿½åŠ æˆåŠŸ: ${name}`);
          markVoted();
        })
        .catch((err) => log("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + err.message));

      document.getElementById("songName").value = "";
      document.getElementById("songUrl").value = "";
    }

    loadVotes();
  </script>
</body>
</html>
