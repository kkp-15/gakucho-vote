<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å¥½ããªğŸ¦å­¦é•·ã®æ›²ã¯ï¼Ÿ</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    h1 {
      font-size: 1.8em;
      color: #1a237e;
      margin-bottom: 20px;
      text-align: center;
    }
    h3 {
      font-size: 1.3em;
      margin-top: 40px;
      color: #444;
    }
    input, button {
      padding: 8px;
      margin: 5px;
    }
    .option {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #ddd;
    }
    .option a {
      flex: 1 1 100%;
      text-decoration: underline;
      font-weight: bold;
      color: #1a73e8;
      cursor: pointer;
      word-break: break-word;
    }
    .votes {
      flex-shrink: 0;
      font-weight: bold;
      color: #007acc;
      min-width: 90px;
    }
    .vote-button, .option span {
      flex-shrink: 0;
      white-space: nowrap;
    }
    #message {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #00c853;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <h1>å¥½ããªğŸ¦å­¦é•·ã®æ›²ã¯ï¼Ÿ</h1>

  <div style="background:#f0f8ff; padding:10px; border-left:5px solid #00aaff; margin-bottom:20px;">
    <h2>ã“ã®ã‚µã‚¤ãƒˆã®ä½¿ã„æ–¹</h2>
    <ul>
      <li>å¥½ããªæ›²ã«ã€ŒæŠ•ç¥¨ã€ãƒœã‚¿ãƒ³ã§1ç¥¨å…¥ã‚Œã‚‰ã‚Œã¾ã™ã€‚</li>
      <li><strong>ã€Œæ–°ã—ã„æ›²ã‚’è¿½åŠ ã€</strong>ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã€æ›²åã¨ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦æ–°ã—ãå€™è£œã‚’è¿½åŠ ã§ãã¾ã™ã€‚<br><span style="color:red;">â€»è¿½åŠ ã—ãŸã ã‘ã§ã¯æŠ•ç¥¨ã•ã‚Œã¾ã›ã‚“ã€‚</span></li>
      <li>â€»æŠ•ç¥¨å…ˆã¯<strong>ä½•åº¦ã§ã‚‚è‡ªç”±ã«å¤‰æ›´å¯èƒ½</strong>ã§ã™ï¼ˆ1äºº1ç¥¨ã¯ç¶­æŒï¼‰</li>
    </ul>
  </div>

  <div id="options"></div>

  <h3>æ–°ã—ã„æ›²ã‚’è¿½åŠ </h3>
  <input type="text" id="songName" placeholder="æ›²å" />
  <input type="url" id="songUrl" placeholder="ãƒªãƒ³ã‚¯ï¼ˆhttps://ã€œï¼‰" />
  <button onclick="addOption()">è¿½åŠ </button>

  <div id="message"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCFpBVVdN_dLLCq45yQxxxxxxx",
      authDomain: "gakucho-vote.firebaseapp.com",
      databaseURL: "https://gakucho-vote-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gakucho-vote",
      storageBucket: "gakucho-vote.appspot.com",
      messagingSenderId: "163899893304",
      appId: "1:163899893304:web:928b73xxxxxxxx"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const optionsDiv = document.getElementById("options");

    function showMessage(text) {
      const msg = document.getElementById("message");
      msg.textContent = text;
      msg.style.display = "block";
      setTimeout(() => {
        msg.style.display = "none";
      }, 2000);
    }

    function getVotedKey() {
      return localStorage.getItem("votedKey");
    }

    function setVotedKey(key) {
      localStorage.setItem("votedKey", key);
    }

    function loadVotes() {
      db.ref("songs").on("value", (snapshot) => {
        const data = snapshot.val() || {};
        optionsDiv.innerHTML = "";
        const votedKey = getVotedKey();

        Object.entries(data)
          .sort((a, b) => (b[1].votes || 0) - (a[1].votes || 0))
          .forEach(([key, value], index) => {
            const wrapper = document.createElement("div");
            wrapper.className = "option";

            const crown = index === 0 ? "ğŸ‘‘" : index === 1 ? "ğŸ¥ˆ" : index === 2 ? "ğŸ¥‰" : `${index + 1}.`;

            const link = document.createElement("a");
            link.href = value.url;
            link.target = "_blank";
            link.textContent = `${crown} ${value.name}`;
            wrapper.appendChild(link);

            const voteCount = document.createElement("div");
            voteCount.className = "votes";
            voteCount.textContent = `ğŸ—³ï¸ ${value.votes || 0} ç¥¨`;
            wrapper.appendChild(voteCount);

            if (votedKey === key) {
              const msg = document.createElement("span");
              msg.textContent = "âœ… ã‚ãªãŸã®æŠ•ç¥¨";
              msg.style.color = "green";
              msg.style.fontWeight = "bold";
              wrapper.appendChild(msg);
            } else {
              const btn = document.createElement("button");
              btn.className = "vote-button";
              btn.textContent = "ğŸ” æŠ•ç¥¨ã™ã‚‹";
              btn.onclick = () => vote(key);
              wrapper.appendChild(btn);
            }

            optionsDiv.appendChild(wrapper);
          });
      });
    }

    function vote(newKey) {
      const oldKey = getVotedKey();

      if (oldKey === newKey) {
        showMessage("ã™ã§ã«ã“ã®æ›²ã«æŠ•ç¥¨æ¸ˆã¿ã§ã™ï¼");
        return;
      }

      if (oldKey && oldKey !== newKey) {
        db.ref("songs/" + oldKey + "/votes").transaction((currentVotes) => {
          return Math.max(0, (currentVotes || 1) - 1);
        });
      }

      db.ref("songs/" + newKey + "/votes").transaction((currentVotes) => {
        return (currentVotes || 0) + 1;
      });

      setVotedKey(newKey);
      showMessage("æŠ•ç¥¨ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
    }

    function addOption() {
      const nameInput = document.getElementById("songName");
      const urlInput = document.getElementById("songUrl");
      const name = nameInput.value.trim();
      const url = urlInput.value.trim();
      if (!url) return showMessage("ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

      const finalName = name || (url.includes("suno.ai") ? "Sunoã®æ›²" : "ã‚¿ã‚¤ãƒˆãƒ«ãªã—");
      const key = finalName.replace(/[.#$î€î€]/g, "_");

      db.ref("songs/" + key).set({ name: finalName, url, votes: 0 });

      nameInput.value = "";
      urlInput.value = "";
      showMessage("æ›²ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼");
    }

    loadVotes();
  </script>
</body>
</html>
